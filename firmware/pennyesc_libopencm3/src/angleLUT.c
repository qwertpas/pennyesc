#include "angleLUT.h"
#include <stdint.h>

// ==========================================
// CONFIGURATION: Match Python script settings
// ==========================================
#define LUT_BITS 7
#define SEGMENT_SIZE (1U << LUT_BITS)  // 256
#define SEGMENT_MASK (SEGMENT_SIZE - 1) // 255
#define TOTAL_LUT_SIZE (8 * SEGMENT_SIZE) // 2048

// ==========================================
// LOOKUP TABLE: Combined Octant+Linearization LUT
// ==========================================
// This table maps a pseudo-index (octant + slope) to corrected angle in radians.
// The table is generated by octant.py and corrects for magnetometer distortion
// (non-orthogonality, amplitude mismatch, phase shift).
// Size: 2048 entries (8 octants Ã— 256 segments per octant)
// Stored in flash memory (const) to save RAM

static const float OCTANT_LUT[TOTAL_LUT_SIZE] = {
    0.65373f, 0.65627f, 0.65882f, 0.66136f, 0.66391f, 0.66645f, 0.66899f, 0.67154f,
    0.67408f, 0.67662f, 0.67917f, 0.68171f, 0.68426f, 0.68680f, 0.68934f, 0.69189f,
    0.69443f, 0.69698f, 0.69877f, 0.70289f, 0.70700f, 0.71111f, 0.71523f, 0.71934f,
    0.72345f, 0.72756f, 0.73168f, 0.73579f, 0.73990f, 0.74401f, 0.74813f, 0.75224f,
    0.75635f, 0.76046f, 0.76458f, 0.76869f, 0.77280f, 0.77692f, 0.78103f, 0.78514f,
    0.78925f, 0.79337f, 0.79748f, 0.80159f, 0.80570f, 0.80982f, 0.81393f, 0.81804f,
    0.82216f, 0.82627f, 0.83038f, 0.83449f, 0.83861f, 0.84272f, 0.84683f, 0.85094f,
    0.85506f, 0.85917f, 0.86328f, 0.86740f, 0.87151f, 0.87499f, 0.87849f, 0.88198f,
    0.88547f, 0.88897f, 0.89246f, 0.89596f, 0.89945f, 0.90294f, 0.90644f, 0.90993f,
    0.91342f, 0.91692f, 0.92041f, 0.92391f, 0.92740f, 0.93089f, 0.93439f, 0.93788f,
    0.94137f, 0.94487f, 0.94836f, 0.95185f, 0.95535f, 0.95884f, 0.96234f, 0.96583f,
    0.96932f, 0.97282f, 0.97631f, 0.97980f, 0.98330f, 0.98679f, 0.99028f, 0.99378f,
    0.99727f, 1.00077f, 1.00426f, 1.00775f, 1.01125f, 1.01474f, 1.01823f, 1.02173f,
    1.02522f, 1.02871f, 1.03221f, 1.03570f, 1.03920f, 1.04269f, 1.04618f, 1.04720f,
    1.05053f, 1.05463f, 1.05872f, 1.06282f, 1.06692f, 1.07102f, 1.07512f, 1.07922f,
    1.08331f, 1.08741f, 1.09151f, 1.09561f, 1.09971f, 1.10381f, 1.10790f, 1.11200f,
    1.11610f, 1.12020f, 1.12430f, 1.12840f, 1.13249f, 1.13659f, 1.14069f, 1.14479f,
    1.14889f, 1.15298f, 1.15708f, 1.16118f, 1.16528f, 1.16938f, 1.17348f, 1.17757f,
    1.18167f, 1.18577f, 1.18987f, 1.19397f, 1.19807f, 1.20216f, 1.20626f, 1.21036f,
    1.21446f, 1.21856f, 1.22173f, 1.22910f, 1.23671f, 1.24432f, 1.25193f, 1.25954f,
    1.26715f, 1.27476f, 1.28237f, 1.28998f, 1.29759f, 1.30520f, 1.31281f, 1.32042f,
    1.32803f, 1.33564f, 1.34325f, 1.35086f, 1.35847f, 1.36608f, 1.37369f, 1.38130f,
    1.38891f, 1.39626f, 1.40001f, 1.40589f, 1.41177f, 1.41766f, 1.42354f, 1.42942f,
    1.43531f, 1.44119f, 1.44707f, 1.45296f, 1.45884f, 1.46472f, 1.47060f, 1.47649f,
    1.48237f, 1.48825f, 1.49414f, 1.50002f, 1.50590f, 1.51179f, 1.51767f, 1.52355f,
    1.52944f, 1.53532f, 1.54120f, 1.54709f, 1.55297f, 1.55885f, 1.56473f, 1.57062f,
    1.57761f, 1.59003f, 1.60246f, 1.61488f, 1.62730f, 1.63973f, 1.65215f, 1.66458f,
    1.67700f, 1.68942f, 1.70185f, 1.71427f, 1.72669f, 1.73912f, 1.75696f, 1.78024f,
    1.80351f, 1.82678f, 1.85005f, 1.87332f, 1.89659f, 1.91986f, 1.94363f, 1.96739f,
    1.99116f, 2.01493f, 2.03869f, 2.06246f, 2.08623f, 2.09655f, 2.10517f, 2.11379f,
    2.12241f, 2.13103f, 2.13964f, 2.14826f, 2.15688f, 2.16550f, 2.17412f, 2.18274f,
    2.19136f, 2.19998f, 2.20860f, 2.21721f, 2.22583f, 2.23445f, 2.24307f, 2.25169f,
    2.26031f, 2.26893f, 2.28893f, 2.31101f, 2.33308f, 2.35516f, 2.37724f, 2.39931f,
    2.42139f, 2.44346f, 2.44741f, 2.46103f, 2.47464f, 2.48825f, 2.50186f, 2.51548f,
    2.52909f, 2.54270f, 2.55631f, 2.56992f, 2.58354f, 2.59715f, 2.61076f, 2.61913f,
    2.62818f, 2.63723f, 2.64628f, 2.65533f, 2.66439f, 2.67344f, 2.68249f, 2.69154f,
    2.70059f, 2.70964f, 2.71870f, 2.72775f, 2.73680f, 2.74585f, 2.75490f, 2.76396f,
    2.77301f, 2.78206f, 2.79111f, 2.79767f, 2.80514f, 2.81262f, 2.82010f, 2.82757f,
    2.83505f, 2.84253f, 2.85000f, 2.85748f, 2.86496f, 2.87243f, 2.87991f, 2.88739f,
    2.89486f, 2.90234f, 2.90982f, 2.91729f, 2.92477f, 2.93225f, 2.93972f, 2.94720f,
    2.95468f, 2.96215f, 2.96800f, 2.97399f, 2.97999f, 2.98598f, 2.99198f, 2.99797f,
    3.00397f, 3.00996f, 3.01596f, 3.02195f, 3.02795f, 3.03394f, 3.03993f, 3.04593f,
    3.05192f, 3.05792f, 3.06391f, 3.06991f, 3.07590f, 3.08190f, 3.08789f, 3.09389f,
    3.09988f, 3.10588f, 3.11187f, 3.11787f, 3.12386f, 3.12986f, 3.13585f, 3.14159f,
    3.14159f, 3.14159f, 3.14159f, 3.14159f, 3.14159f, 3.14159f, 3.14159f, 3.14186f,
    3.14481f, 3.14777f, 3.15072f, 3.15368f, 3.15663f, 3.15958f, 3.16254f, 3.16549f,
    3.16844f, 3.17140f, 3.17435f, 3.17730f, 3.18026f, 3.18321f, 3.18617f, 3.18912f,
    3.19207f, 3.19503f, 3.19798f, 3.20093f, 3.20389f, 3.20684f, 3.20979f, 3.21275f,
    3.21570f, 3.21866f, 3.22161f, 3.22456f, 3.22752f, 3.23047f, 3.23342f, 3.23638f,
    3.23933f, 3.24228f, 3.24524f, 3.24819f, 3.25115f, 3.25410f, 3.25705f, 3.26001f,
    3.26296f, 3.26591f, 3.26887f, 3.27182f, 3.27477f, 3.27773f, 3.28068f, 3.28364f,
    3.28659f, 3.28954f, 3.29250f, 3.29545f, 3.29840f, 3.30136f, 3.30431f, 3.30726f,
    3.31022f, 3.31317f, 3.31613f, 3.31879f, 3.32371f, 3.32862f, 3.33354f, 3.33845f,
    3.34337f, 3.34828f, 3.35320f, 3.35811f, 3.36303f, 3.36794f, 3.37286f, 3.37777f,
    3.38269f, 3.38761f, 3.39252f, 3.39744f, 3.40235f, 3.40727f, 3.41218f, 3.41710f,
    3.42201f, 3.42693f, 3.43184f, 3.43676f, 3.44167f, 3.44659f, 3.45150f, 3.45642f,
    3.46133f, 3.46625f, 3.47116f, 3.47608f, 3.48099f, 3.48591f, 3.49066f, 3.49066f,
    3.49274f, 3.49497f, 3.49719f, 3.49942f, 3.50165f, 3.50387f, 3.50610f, 3.50832f,
    3.51055f, 3.51277f, 3.51500f, 3.51722f, 3.51945f, 3.52167f, 3.52390f, 3.52612f,
    3.52835f, 3.53057f, 3.53280f, 3.53502f, 3.53725f, 3.53947f, 3.54170f, 3.54392f,
    3.54615f, 3.54837f, 3.55060f, 3.55282f, 3.55505f, 3.55727f, 3.55950f, 3.56172f,
    3.56395f, 3.56617f, 3.56840f, 3.57062f, 3.57285f, 3.57507f, 3.57730f, 3.57952f,
    3.58175f, 3.58397f, 3.58620f, 3.58842f, 3.59065f, 3.59287f, 3.59510f, 3.59733f,
    3.59955f, 3.60178f, 3.60400f, 3.60623f, 3.60845f, 3.61068f, 3.61290f, 3.61513f,
    3.61735f, 3.61958f, 3.62180f, 3.62403f, 3.62625f, 3.62848f, 3.63070f, 3.63293f,
    3.63515f, 3.63738f, 3.63960f, 3.64183f, 3.64405f, 3.64628f, 3.64850f, 3.65073f,
    3.65295f, 3.65518f, 3.65740f, 3.65963f, 3.66185f, 3.66408f, 3.66693f, 3.67156f,
    3.67619f, 3.68082f, 3.68545f, 3.69008f, 3.69471f, 3.69934f, 3.70397f, 3.70860f,
    3.71323f, 3.71786f, 3.72249f, 3.72712f, 3.73175f, 3.73637f, 3.74100f, 3.74563f,
    3.75026f, 3.75489f, 3.75952f, 3.76415f, 3.76878f, 3.77341f, 3.77804f, 3.78267f,
    3.78730f, 3.79193f, 3.79656f, 3.80119f, 3.80582f, 3.81045f, 3.81508f, 3.81971f,
    3.82434f, 3.82897f, 3.83360f, 3.83823f, 3.84007f, 3.84580f, 3.85154f, 3.85727f,
    3.86300f, 3.86873f, 3.87447f, 3.88020f, 3.88593f, 3.89166f, 3.89739f, 3.90313f,
    3.90886f, 3.91459f, 3.92032f, 3.92606f, 3.93179f, 3.93752f, 3.94325f, 3.94898f,
    3.95472f, 3.96045f, 3.96618f, 3.97191f, 3.97765f, 3.98338f, 3.98911f, 3.99484f,
    4.00057f, 4.00631f, 4.01204f, 4.01723f, 4.02453f, 4.03184f, 4.03914f, 4.04645f,
    4.05375f, 4.06106f, 4.06836f, 4.07567f, 4.08298f, 4.09028f, 4.09759f, 4.10489f,
    4.11220f, 4.11950f, 4.12681f, 4.13412f, 4.14142f, 4.14873f, 4.15603f, 4.16334f,
    4.17064f, 4.17795f, 4.18526f, 4.18966f, 4.19244f, 4.19522f, 4.19800f, 4.20078f,
    4.20357f, 4.20635f, 4.20913f, 4.21191f, 4.21469f, 4.21747f, 4.22025f, 4.22304f,
    4.22582f, 4.22860f, 4.23138f, 4.23416f, 4.23694f, 4.23972f, 4.24251f, 4.24529f,
    4.24807f, 4.25085f, 4.25363f, 4.25641f, 4.25919f, 4.26198f, 4.26476f, 4.26754f,
    4.27032f, 4.27310f, 4.27588f, 4.27866f, 4.28145f, 4.28423f, 4.28701f, 4.28979f,
    4.29257f, 4.29535f, 4.29813f, 4.30092f, 4.30370f, 4.30648f, 4.30926f, 4.31204f,
    4.31482f, 4.31760f, 4.32039f, 4.32317f, 4.32595f, 4.32873f, 4.33151f, 4.33429f,
    4.33707f, 4.33986f, 4.34264f, 4.34542f, 4.34820f, 4.35098f, 4.35376f, 4.35654f,
    4.35932f, 4.36211f, 4.37037f, 4.38717f, 4.40398f, 4.42078f, 4.43758f, 4.45438f,
    4.47119f, 4.48799f, 4.50479f, 4.52160f, 4.53786f, 4.54567f, 4.55758f, 4.56949f,
    4.58140f, 4.59330f, 4.60521f, 4.61712f, 4.62903f, 4.64094f, 4.65285f, 4.66476f,
    4.67666f, 4.68857f, 4.70048f, 4.71239f, 4.71942f, 4.73393f, 4.74843f, 4.76293f,
    4.77744f, 4.79194f, 4.80645f, 4.82095f, 4.83546f, 4.84996f, 4.86446f, 4.87897f,
    4.89094f, 4.90989f, 4.92883f, 4.94778f, 4.96672f, 4.98567f, 5.00462f, 5.02356f,
    5.04251f, 5.06145f, 5.07589f, 5.09689f, 5.11788f, 5.13888f, 5.15988f, 5.18087f,
    5.20187f, 5.22286f, 5.23599f, 5.25631f, 5.27804f, 5.29977f, 5.32150f, 5.34323f,
    5.36496f, 5.38669f, 5.40842f, 5.42537f, 5.45508f, 5.48479f, 5.51450f, 5.54421f,
    5.57391f, 5.58614f, 5.59770f, 5.60926f, 5.62083f, 5.63239f, 5.64395f, 5.65552f,
    5.66708f, 5.67864f, 5.69021f, 5.70177f, 5.71333f, 5.72490f, 5.73646f, 5.74802f,
    5.75959f, 5.77413f, 5.78868f, 5.80322f, 5.81776f, 5.83231f, 5.84685f, 5.86140f,
    5.87594f, 5.89049f, 5.90503f, 5.91958f, 5.93412f, 5.93839f, 5.95731f, 5.97623f,
    5.99514f, 6.01406f, 6.03298f, 6.05190f, 6.07082f, 6.08973f, 6.10865f, 6.12262f,
    6.13658f, 6.15054f, 6.16450f, 6.17847f, 6.19243f, 6.20639f, 6.22035f, 6.23432f,
    6.24828f, 6.26224f, 6.27620f, 0.00056f, 0.00346f, 0.00636f, 0.00926f, 0.01217f,
    0.01507f, 0.01797f, 0.02087f, 0.02377f, 0.02667f, 0.02957f, 0.03247f, 0.03537f,
    0.03827f, 0.04118f, 0.04408f, 0.04698f, 0.04988f, 0.05278f, 0.05568f, 0.05858f,
    0.06148f, 0.06438f, 0.06729f, 0.07019f, 0.07309f, 0.07599f, 0.07889f, 0.08179f,
    0.08469f, 0.08759f, 0.09049f, 0.09339f, 0.09630f, 0.09920f, 0.10210f, 0.10500f,
    0.10790f, 0.11080f, 0.11370f, 0.11660f, 0.11950f, 0.12240f, 0.12531f, 0.12821f,
    0.13111f, 0.13401f, 0.13691f, 0.13981f, 0.14271f, 0.14561f, 0.14851f, 0.15142f,
    0.15432f, 0.15722f, 0.16012f, 0.16302f, 0.16592f, 0.16882f, 0.17172f, 0.17453f,
    0.17568f, 0.17937f, 0.18305f, 0.18673f, 0.19041f, 0.19409f, 0.19777f, 0.20145f,
    0.20514f, 0.20882f, 0.21250f, 0.21618f, 0.21986f, 0.22354f, 0.22723f, 0.23091f,
    0.23459f, 0.23827f, 0.24195f, 0.24563f, 0.24932f, 0.25300f, 0.25668f, 0.26036f,
    0.26404f, 0.26772f, 0.27141f, 0.27509f, 0.27877f, 0.28245f, 0.28613f, 0.28981f,
    0.29350f, 0.29718f, 0.30086f, 0.30454f, 0.30822f, 0.31190f, 0.31559f, 0.31927f,
    0.32295f, 0.32663f, 0.33031f, 0.33399f, 0.33768f, 0.34136f, 0.34504f, 0.34872f,
    0.35123f, 0.35452f, 0.35781f, 0.36111f, 0.36440f, 0.36769f, 0.37099f, 0.37428f,
    0.37757f, 0.38086f, 0.38416f, 0.38745f, 0.39074f, 0.39404f, 0.39733f, 0.40062f,
    0.40392f, 0.40721f, 0.41050f, 0.41380f, 0.41709f, 0.42038f, 0.42367f, 0.42697f,
    0.43026f, 0.43355f, 0.43685f, 0.44014f, 0.44343f, 0.44673f, 0.45002f, 0.45331f,
    0.45661f, 0.45990f, 0.46319f, 0.46648f, 0.46978f, 0.47307f, 0.47636f, 0.47966f,
    0.48295f, 0.48624f, 0.48954f, 0.49283f, 0.49612f, 0.49942f, 0.50271f, 0.50600f,
    0.50929f, 0.51259f, 0.51588f, 0.51917f, 0.52247f, 0.52400f, 0.52654f, 0.52908f,
    0.53163f, 0.53417f, 0.53672f, 0.53926f, 0.54180f, 0.54435f, 0.54689f, 0.54943f,
    0.55198f, 0.55452f, 0.55707f, 0.55961f, 0.56215f, 0.56470f, 0.56724f, 0.56978f,
    0.57233f, 0.57487f, 0.57742f, 0.57996f, 0.58250f, 0.58505f, 0.58759f, 0.59014f,
    0.59268f, 0.59522f, 0.59777f, 0.60031f, 0.60285f, 0.60540f, 0.60794f, 0.61049f,
    0.61303f, 0.61557f, 0.61812f, 0.62066f, 0.62320f, 0.62575f, 0.62829f, 0.63084f,
    0.63338f, 0.63592f, 0.63847f, 0.64101f, 0.64356f, 0.64610f, 0.64864f, 0.65119f
    };
// ==========================================
// HELPER FUNCTIONS
// ==========================================

uint16_t angleLUT_get_size(void)
{
    return TOTAL_LUT_SIZE;
}

// ==========================================
// MAIN FUNCTION: Fast Angle Calculation
// ==========================================

float angleLUT_get_angle(int16_t x, int16_t y)
{
    // Step 1: Get absolute values (using int32 to prevent overflow)
    int32_t ax = (x < 0) ? -x : x;
    int32_t ay = (y < 0) ? -y : y;

    // Step 2: Determine octant and calculate scaled ratio
    // Octants: 0-7 covering 0-360 degrees in 45-degree segments
    // Ratio: min/max scaled to SEGMENT_SIZE for sub-octant resolution
    uint8_t octant;
    int32_t ratio_scaled;

    if (ax > ay) {
        // X is dominant (octants 0, 3, 4, 7)
        if (x >= 0) {
            octant = (y >= 0) ? 0 : 7;  // Quadrant I or IV
        } else {
            octant = (y >= 0) ? 3 : 4;  // Quadrant II or III
        }
        // Calculate ratio: (ay/ax) * SEGMENT_SIZE
        // Safe division: ax > 0 guaranteed if ax > ay
        ratio_scaled = (ay * SEGMENT_SIZE) / ax;
    } else {
        // Y is dominant (octants 1, 2, 5, 6)
        if (y >= 0) {
            octant = (x >= 0) ? 1 : 2;  // Quadrant I or II
        } else {
            octant = (x >= 0) ? 6 : 5;  // Quadrant IV or III
        }
        // Calculate ratio: (ax/ay) * SEGMENT_SIZE
        if (ay == 0) {
            ratio_scaled = 0;  // Handle edge case (both zero)
        } else {
            ratio_scaled = (ax * SEGMENT_SIZE) / ay;
        }
    }

    // Step 3: Handle zig-zag pattern for monotonicity
    // Even octants (0,2,4,6): angle increases as ratio increases
    // Odd octants (1,3,5,7): angle increases as ratio decreases
    // This creates a continuous index across octant boundaries
    uint16_t index_in_segment;
    if (octant & 1) {
        // Odd octant: reverse the ratio
        index_in_segment = (SEGMENT_SIZE - 1) - (uint16_t)ratio_scaled;
    } else {
        // Even octant: use ratio directly
        index_in_segment = (uint16_t)ratio_scaled;
    }

    // Clamp index to valid range (safety check)
    if (index_in_segment > SEGMENT_MASK) {
        index_in_segment = SEGMENT_MASK;
    }

    // Step 4: Calculate final lookup table index
    // Format: [octant (3 bits)][segment_index (8 bits)] = 11 bits total
    uint16_t total_index = ((uint16_t)octant << LUT_BITS) | index_in_segment;

    // Step 5: Bounds check and lookup
    if (total_index >= TOTAL_LUT_SIZE) {
        total_index = TOTAL_LUT_SIZE - 1;  // Clamp to last entry
    }

    return OCTANT_LUT[total_index];
}