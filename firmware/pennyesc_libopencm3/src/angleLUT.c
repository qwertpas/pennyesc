#include "angleLUT.h"
#include <stdint.h>

// ==========================================
// CONFIGURATION: Match Python script settings
// ==========================================
#define LUT_BITS 7
#define SEGMENT_SIZE (1U << LUT_BITS)  // 256
#define SEGMENT_MASK (SEGMENT_SIZE - 1) // 255
#define TOTAL_LUT_SIZE (8 * SEGMENT_SIZE) // 2048

// ==========================================
// LOOKUP TABLE: Combined Octant+Linearization LUT
// ==========================================
// This table maps a pseudo-index (octant + slope) to corrected angle in radians.
// The table is generated by octant.py and corrects for magnetometer distortion
// (non-orthogonality, amplitude mismatch, phase shift).
// Size: 2048 entries (8 octants Ã— 256 segments per octant)
// Stored in flash memory (const) to save RAM

static const float OCTANT_LUT[TOTAL_LUT_SIZE] = {
    0.61710f, 0.62084f, 0.62458f, 0.62832f, 0.63206f, 0.63580f, 0.63954f, 0.64328f,
    0.64702f, 0.65076f, 0.65450f, 0.65824f, 0.66198f, 0.66572f, 0.66946f, 0.67320f,
    0.67694f, 0.68068f, 0.68442f, 0.68816f, 0.69190f, 0.69564f, 0.69874f, 0.70117f,
    0.70360f, 0.70604f, 0.70847f, 0.71090f, 0.71333f, 0.71577f, 0.71820f, 0.72063f,
    0.72306f, 0.72550f, 0.72793f, 0.73036f, 0.73280f, 0.73523f, 0.73766f, 0.74009f,
    0.74253f, 0.74496f, 0.74739f, 0.74982f, 0.75226f, 0.75469f, 0.75712f, 0.75955f,
    0.76199f, 0.76442f, 0.76685f, 0.76928f, 0.77172f, 0.77415f, 0.77658f, 0.77901f,
    0.78145f, 0.78388f, 0.78631f, 0.78874f, 0.79118f, 0.79361f, 0.79604f, 0.79847f,
    0.80091f, 0.80334f, 0.80577f, 0.80820f, 0.81064f, 0.81307f, 0.81550f, 0.81793f,
    0.82037f, 0.82280f, 0.82523f, 0.82766f, 0.83010f, 0.83253f, 0.83496f, 0.83739f,
    0.83983f, 0.84226f, 0.84469f, 0.84712f, 0.84956f, 0.85199f, 0.85442f, 0.85685f,
    0.85929f, 0.86172f, 0.86415f, 0.86658f, 0.86902f, 0.87145f, 0.87600f, 0.88436f,
    0.89271f, 0.90106f, 0.90941f, 0.91776f, 0.92611f, 0.93446f, 0.94281f, 0.95116f,
    0.95951f, 0.96786f, 0.97622f, 0.98457f, 0.99292f, 1.00127f, 1.00962f, 1.01797f,
    1.02632f, 1.03467f, 1.04302f, 1.04869f, 1.05241f, 1.05613f, 1.05985f, 1.06357f,
    1.06729f, 1.07101f, 1.07474f, 1.07846f, 1.08218f, 1.08590f, 1.08962f, 1.09334f,
    1.09706f, 1.10079f, 1.10451f, 1.10823f, 1.11195f, 1.11567f, 1.11939f, 1.12311f,
    1.12684f, 1.13056f, 1.13428f, 1.13800f, 1.14172f, 1.14544f, 1.14916f, 1.15288f,
    1.15661f, 1.16033f, 1.16405f, 1.16777f, 1.17149f, 1.17521f, 1.17893f, 1.18266f,
    1.18638f, 1.19010f, 1.19382f, 1.19754f, 1.20126f, 1.20498f, 1.20871f, 1.21243f,
    1.21615f, 1.21987f, 1.22173f, 1.22658f, 1.23143f, 1.23627f, 1.24112f, 1.24597f,
    1.25082f, 1.25567f, 1.26052f, 1.26536f, 1.27021f, 1.27506f, 1.27991f, 1.28476f,
    1.28960f, 1.29445f, 1.29930f, 1.30415f, 1.30900f, 1.31385f, 1.31869f, 1.32354f,
    1.32839f, 1.33324f, 1.33809f, 1.34293f, 1.34778f, 1.35263f, 1.35748f, 1.36233f,
    1.36717f, 1.37202f, 1.37687f, 1.38172f, 1.38657f, 1.39142f, 1.39626f, 1.40803f,
    1.41980f, 1.43156f, 1.44333f, 1.45509f, 1.46686f, 1.47863f, 1.49039f, 1.50216f,
    1.51393f, 1.52569f, 1.53746f, 1.54922f, 1.56099f, 1.57080f, 1.61235f, 1.65391f,
    1.69546f, 1.73702f, 1.74720f, 1.75841f, 1.76962f, 1.78083f, 1.79205f, 1.80326f,
    1.81447f, 1.82568f, 1.83689f, 1.84811f, 1.85932f, 1.87053f, 1.88174f, 1.89295f,
    1.90417f, 1.91538f, 1.92745f, 1.94263f, 1.95780f, 1.97298f, 1.98816f, 2.00333f,
    2.01851f, 2.03369f, 2.04886f, 2.06404f, 2.07922f, 2.09440f, 2.13803f, 2.18166f,
    2.22529f, 2.26893f, 2.29074f, 2.31256f, 2.33438f, 2.35619f, 2.37801f, 2.39983f,
    2.42164f, 2.44346f, 2.44747f, 2.45750f, 2.46753f, 2.47757f, 2.48760f, 2.49763f,
    2.50766f, 2.51769f, 2.52772f, 2.53775f, 2.54778f, 2.55781f, 2.56784f, 2.57787f,
    2.58790f, 2.59793f, 2.60796f, 2.61799f, 2.63295f, 2.64791f, 2.66287f, 2.67783f,
    2.69279f, 2.70775f, 2.72271f, 2.73767f, 2.75263f, 2.76759f, 2.78255f, 2.79253f,
    2.79887f, 2.80522f, 2.81157f, 2.81791f, 2.82426f, 2.83061f, 2.83695f, 2.84330f,
    2.84965f, 2.85599f, 2.86234f, 2.86869f, 2.87503f, 2.88138f, 2.88773f, 2.89407f,
    2.90042f, 2.90677f, 2.91311f, 2.91946f, 2.92581f, 2.93215f, 2.93850f, 2.94485f,
    2.95119f, 2.95754f, 2.96389f, 2.96706f, 2.98888f, 3.01069f, 3.03251f, 3.05433f,
    3.07614f, 3.09796f, 3.11978f, 3.14159f, 3.14333f, 3.14768f, 3.15203f, 3.15637f,
    3.16072f, 3.16507f, 3.16941f, 3.17376f, 3.17811f, 3.18245f, 3.18680f, 3.19115f,
    3.19550f, 3.19984f, 3.20419f, 3.20854f, 3.21288f, 3.21723f, 3.22158f, 3.22592f,
    3.23027f, 3.23462f, 3.23897f, 3.24331f, 3.24766f, 3.25201f, 3.25635f, 3.26070f,
    3.26505f, 3.26940f, 3.27374f, 3.27809f, 3.28244f, 3.28678f, 3.29113f, 3.29548f,
    3.29982f, 3.30417f, 3.30852f, 3.31287f, 3.31613f, 3.31768f, 3.31974f, 3.32181f,
    3.32388f, 3.32595f, 3.32801f, 3.33008f, 3.33215f, 3.33422f, 3.33628f, 3.33835f,
    3.34042f, 3.34249f, 3.34455f, 3.34662f, 3.34869f, 3.35076f, 3.35282f, 3.35489f,
    3.35696f, 3.35903f, 3.36109f, 3.36316f, 3.36523f, 3.36730f, 3.36936f, 3.37143f,
    3.37350f, 3.37557f, 3.37763f, 3.37970f, 3.38177f, 3.38384f, 3.38590f, 3.38797f,
    3.39004f, 3.39211f, 3.39417f, 3.39624f, 3.39831f, 3.40038f, 3.40244f, 3.40451f,
    3.40658f, 3.40865f, 3.41071f, 3.41278f, 3.41485f, 3.41692f, 3.41898f, 3.42105f,
    3.42312f, 3.42519f, 3.42725f, 3.42932f, 3.43139f, 3.43346f, 3.43552f, 3.43759f,
    3.43966f, 3.44173f, 3.44379f, 3.44586f, 3.44793f, 3.45000f, 3.45206f, 3.45413f,
    3.45620f, 3.45827f, 3.46033f, 3.46240f, 3.46447f, 3.46654f, 3.46860f, 3.47067f,
    3.47274f, 3.47481f, 3.47688f, 3.47894f, 3.48101f, 3.48308f, 3.48515f, 3.48721f,
    3.48928f, 3.49066f, 3.49335f, 3.49672f, 3.50009f, 3.50346f, 3.50683f, 3.51020f,
    3.51357f, 3.51694f, 3.52031f, 3.52368f, 3.52705f, 3.53042f, 3.53379f, 3.53716f,
    3.54053f, 3.54389f, 3.54726f, 3.55063f, 3.55400f, 3.55737f, 3.56074f, 3.56411f,
    3.56748f, 3.57085f, 3.57422f, 3.57759f, 3.58096f, 3.58433f, 3.58770f, 3.59107f,
    3.59443f, 3.59780f, 3.60117f, 3.60454f, 3.60791f, 3.61128f, 3.61465f, 3.61802f,
    3.62139f, 3.62476f, 3.62813f, 3.63150f, 3.63487f, 3.63824f, 3.64161f, 3.64498f,
    3.64834f, 3.65171f, 3.65508f, 3.65845f, 3.66182f, 3.66519f, 3.67496f, 3.68716f,
    3.69937f, 3.71157f, 3.72378f, 3.73598f, 3.74819f, 3.76039f, 3.77260f, 3.78480f,
    3.79701f, 3.80921f, 3.82142f, 3.83362f, 3.84065f, 3.84295f, 3.84525f, 3.84755f,
    3.84986f, 3.85216f, 3.85446f, 3.85676f, 3.85907f, 3.86137f, 3.86367f, 3.86597f,
    3.86828f, 3.87058f, 3.87288f, 3.87518f, 3.87749f, 3.87979f, 3.88209f, 3.88439f,
    3.88670f, 3.88900f, 3.89130f, 3.89360f, 3.89591f, 3.89821f, 3.90051f, 3.90281f,
    3.90512f, 3.90742f, 3.90972f, 3.91202f, 3.91433f, 3.91663f, 3.91893f, 3.92123f,
    3.92354f, 3.92584f, 3.92814f, 3.93044f, 3.93275f, 3.93505f, 3.93735f, 3.93965f,
    3.94196f, 3.94426f, 3.94656f, 3.94886f, 3.95117f, 3.95347f, 3.95577f, 3.95808f,
    3.96038f, 3.96268f, 3.96498f, 3.96729f, 3.96959f, 3.97189f, 3.97419f, 3.97650f,
    3.97880f, 3.98110f, 3.98340f, 3.98571f, 3.98801f, 3.99031f, 3.99261f, 3.99492f,
    3.99722f, 3.99952f, 4.00182f, 4.00413f, 4.00643f, 4.00873f, 4.01103f, 4.01334f,
    4.01426f, 4.01426f, 4.01426f, 4.01674f, 4.01985f, 4.02295f, 4.02606f, 4.02916f,
    4.03227f, 4.03538f, 4.03848f, 4.04159f, 4.04469f, 4.04780f, 4.05090f, 4.05401f,
    4.05711f, 4.06022f, 4.06333f, 4.06643f, 4.06954f, 4.07264f, 4.07575f, 4.07885f,
    4.08196f, 4.08506f, 4.08817f, 4.09128f, 4.09438f, 4.09749f, 4.10059f, 4.10370f,
    4.10680f, 4.10991f, 4.11301f, 4.11612f, 4.11923f, 4.12233f, 4.12544f, 4.12854f,
    4.13165f, 4.13475f, 4.13786f, 4.14096f, 4.14407f, 4.14718f, 4.15028f, 4.15339f,
    4.15649f, 4.15960f, 4.16270f, 4.16581f, 4.16891f, 4.17202f, 4.17513f, 4.17823f,
    4.18134f, 4.18444f, 4.18755f, 4.19327f, 4.20222f, 4.21117f, 4.22012f, 4.22907f,
    4.23802f, 4.24697f, 4.25592f, 4.26487f, 4.27382f, 4.28277f, 4.29172f, 4.30067f,
    4.30962f, 4.31857f, 4.32752f, 4.33647f, 4.34542f, 4.35437f, 4.36332f, 4.36835f,
    4.37462f, 4.38090f, 4.38718f, 4.39346f, 4.39974f, 4.40601f, 4.41229f, 4.41857f,
    4.42485f, 4.43113f, 4.43741f, 4.44368f, 4.44996f, 4.45624f, 4.46252f, 4.46880f,
    4.47507f, 4.48135f, 4.48763f, 4.49391f, 4.50019f, 4.50647f, 4.51274f, 4.51902f,
    4.52530f, 4.53158f, 4.53786f, 4.54367f, 4.54949f, 4.55531f, 4.56113f, 4.56694f,
    4.57276f, 4.57858f, 4.58440f, 4.59022f, 4.59603f, 4.60185f, 4.60767f, 4.61349f,
    4.61930f, 4.62512f, 4.63094f, 4.63676f, 4.64258f, 4.64839f, 4.65421f, 4.66003f,
    4.66585f, 4.67166f, 4.67748f, 4.68330f, 4.68912f, 4.69494f, 4.70075f, 4.70657f,
    4.71239f, 4.72581f, 4.73924f, 4.75267f, 4.76609f, 4.77952f, 4.79294f, 4.80637f,
    4.81979f, 4.83322f, 4.84665f, 4.86007f, 4.87350f, 4.88692f, 4.89690f, 4.90687f,
    4.91684f, 4.92682f, 4.93679f, 4.94676f, 4.95674f, 4.96671f, 4.97668f, 4.98666f,
    4.99663f, 5.00660f, 5.01657f, 5.02655f, 5.03652f, 5.04649f, 5.05647f, 5.06145f,
    5.11279f, 5.16412f, 5.21545f, 5.24358f, 5.25875f, 5.27393f, 5.28911f, 5.30428f,
    5.31946f, 5.33464f, 5.34981f, 5.36499f, 5.38017f, 5.39534f, 5.41052f, 5.42143f,
    5.43234f, 5.44325f, 5.45415f, 5.46506f, 5.47597f, 5.48688f, 5.49779f, 5.50870f,
    5.51960f, 5.53051f, 5.54142f, 5.55233f, 5.56324f, 5.57415f, 5.58505f, 5.60092f,
    5.61679f, 5.63265f, 5.64852f, 5.66439f, 5.68025f, 5.69612f, 5.71199f, 5.72785f,
    5.74372f, 5.75959f, 5.79925f, 5.83892f, 5.87859f, 5.91825f, 5.93544f, 5.94339f,
    5.95133f, 5.95928f, 5.96723f, 5.97517f, 5.98312f, 5.99106f, 5.99901f, 6.00695f,
    6.01490f, 6.02284f, 6.03079f, 6.03873f, 6.04668f, 6.05462f, 6.06257f, 6.07051f,
    6.07846f, 6.08641f, 6.09435f, 6.10230f, 6.10865f, 6.10981f, 6.11563f, 6.12144f,
    6.12725f, 6.13306f, 6.13887f, 6.14468f, 6.15049f, 6.15631f, 6.16212f, 6.16793f,
    6.17374f, 6.17955f, 6.18536f, 6.19117f, 6.19698f, 6.20280f, 6.20861f, 6.21442f,
    6.22023f, 6.22604f, 6.23185f, 6.23766f, 6.24347f, 6.24929f, 6.25510f, 6.26091f,
    6.26672f, 6.27253f, 6.27834f, 0.00000f, 0.01262f, 0.02523f, 0.03785f, 0.05047f,
    0.06308f, 0.07570f, 0.08832f, 0.10093f, 0.11355f, 0.12617f, 0.13879f, 0.15140f,
    0.16402f, 0.17453f, 0.17798f, 0.18142f, 0.18487f, 0.18831f, 0.19176f, 0.19520f,
    0.19865f, 0.20209f, 0.20554f, 0.20898f, 0.21242f, 0.21587f, 0.21931f, 0.22276f,
    0.22620f, 0.22965f, 0.23309f, 0.23654f, 0.23998f, 0.24343f, 0.24687f, 0.25032f,
    0.25376f, 0.25721f, 0.26065f, 0.26410f, 0.26754f, 0.27099f, 0.27443f, 0.27787f,
    0.28132f, 0.28476f, 0.28821f, 0.29165f, 0.29510f, 0.29854f, 0.30199f, 0.30543f,
    0.30888f, 0.31232f, 0.31577f, 0.31921f, 0.32266f, 0.32610f, 0.32955f, 0.33299f,
    0.33644f, 0.33988f, 0.34332f, 0.34677f, 0.34907f, 0.35140f, 0.35374f, 0.35608f,
    0.35842f, 0.36075f, 0.36309f, 0.36543f, 0.36777f, 0.37010f, 0.37244f, 0.37478f,
    0.37712f, 0.37945f, 0.38179f, 0.38413f, 0.38647f, 0.38880f, 0.39114f, 0.39348f,
    0.39582f, 0.39815f, 0.40049f, 0.40283f, 0.40517f, 0.40750f, 0.40984f, 0.41218f,
    0.41452f, 0.41685f, 0.41919f, 0.42153f, 0.42387f, 0.42620f, 0.42854f, 0.43088f,
    0.43322f, 0.43555f, 0.43789f, 0.44023f, 0.44257f, 0.44490f, 0.44724f, 0.44958f,
    0.45192f, 0.45425f, 0.45659f, 0.45893f, 0.46127f, 0.46360f, 0.46594f, 0.46828f,
    0.47062f, 0.47295f, 0.47529f, 0.47763f, 0.47997f, 0.48230f, 0.48464f, 0.48698f,
    0.48932f, 0.49165f, 0.49399f, 0.49633f, 0.49867f, 0.50100f, 0.50334f, 0.50568f,
    0.50802f, 0.51035f, 0.51269f, 0.51503f, 0.51737f, 0.51970f, 0.52204f, 0.52360f,
    0.52734f, 0.53108f, 0.53482f, 0.53856f, 0.54230f, 0.54604f, 0.54978f, 0.55352f,
    0.55726f, 0.56100f, 0.56474f, 0.56848f, 0.57222f, 0.57596f, 0.57970f, 0.58344f,
    0.58718f, 0.59092f, 0.59466f, 0.59840f, 0.60214f, 0.60588f, 0.60962f, 0.61336f
};



// ==========================================
// HELPER FUNCTIONS
// ==========================================

uint16_t angleLUT_get_size(void)
{
    return TOTAL_LUT_SIZE;
}

// ==========================================
// MAIN FUNCTION: Fast Angle Calculation
// ==========================================

float angleLUT_get_angle(int16_t x, int16_t y)
{
    // Step 1: Get absolute values (using int32 to prevent overflow)
    int32_t ax = (x < 0) ? -x : x;
    int32_t ay = (y < 0) ? -y : y;

    // Step 2: Determine octant and calculate scaled ratio
    // Octants: 0-7 covering 0-360 degrees in 45-degree segments
    // Ratio: min/max scaled to SEGMENT_SIZE for sub-octant resolution
    uint8_t octant;
    int32_t ratio_scaled;

    if (ax > ay) {
        // X is dominant (octants 0, 3, 4, 7)
        if (x >= 0) {
            octant = (y >= 0) ? 0 : 7;  // Quadrant I or IV
        } else {
            octant = (y >= 0) ? 3 : 4;  // Quadrant II or III
        }
        // Calculate ratio: (ay/ax) * SEGMENT_SIZE
        // Safe division: ax > 0 guaranteed if ax > ay
        ratio_scaled = (ay * SEGMENT_SIZE) / ax;
    } else {
        // Y is dominant (octants 1, 2, 5, 6)
        if (y >= 0) {
            octant = (x >= 0) ? 1 : 2;  // Quadrant I or II
        } else {
            octant = (x >= 0) ? 6 : 5;  // Quadrant IV or III
        }
        // Calculate ratio: (ax/ay) * SEGMENT_SIZE
        if (ay == 0) {
            ratio_scaled = 0;  // Handle edge case (both zero)
        } else {
            ratio_scaled = (ax * SEGMENT_SIZE) / ay;
        }
    }

    // Step 3: Handle zig-zag pattern for monotonicity
    // Even octants (0,2,4,6): angle increases as ratio increases
    // Odd octants (1,3,5,7): angle increases as ratio decreases
    // This creates a continuous index across octant boundaries
    uint16_t index_in_segment;
    if (octant & 1) {
        // Odd octant: reverse the ratio
        index_in_segment = (SEGMENT_SIZE - 1) - (uint16_t)ratio_scaled;
    } else {
        // Even octant: use ratio directly
        index_in_segment = (uint16_t)ratio_scaled;
    }

    // Clamp index to valid range (safety check)
    if (index_in_segment > SEGMENT_MASK) {
        index_in_segment = SEGMENT_MASK;
    }

    // Step 4: Calculate final lookup table index
    // Format: [octant (3 bits)][segment_index (8 bits)] = 11 bits total
    uint16_t total_index = ((uint16_t)octant << LUT_BITS) | index_in_segment;

    // Step 5: Bounds check and lookup
    if (total_index >= TOTAL_LUT_SIZE) {
        total_index = TOTAL_LUT_SIZE - 1;  // Clamp to last entry
    }

    return OCTANT_LUT[total_index];
}